<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Josie Astrid Consulting</title>
    <link rel="stylesheet" href="./static/style.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="./index.html" class="nav-brand">
                <img src="./static/JAC_Logo.png" alt="Josie Astrid Consulting" class="nav-logo">
            </a>
            <div class="nav-links">
                <a href="./index.html" class="active">Home</a>
                <a href="./about.html">About</a>
                <a href="./contact.html">Contact</a>
            </div>
            <button class="mobile-menu-btn" aria-label="Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
    </nav>

    <main class="main">
        <div class="container">
            <div class="home-content">
                <div class="home-body">
                    <div class="home-text">
                        <h1>Welcome to Josie Astrid Consulting</h1>
                        <p class="main-paragraph">Meet my AI twin. It's trained on my background and my work, and it even speaks in my own voice. Ask it about how I work with clients and what I can help you solve.</p>
                        <button id="vapi-voice-btn" class="voice-btn">
                            <span class="voice-btn-text">TALK TO MY AI TWIN</span>
                        </button>
                        <canvas id="waveform-canvas" class="waveform-canvas" width="300" height="60" style="display: none;"></canvas>
                        <div id="call-status" class="call-status" style="display: none;">
                            <span class="status-text">Call in progress...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay">
        <button class="mobile-menu-close" aria-label="Close menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
        <ul class="mobile-nav-links">
            <li><a href="./index.html" class="active">Home</a></li>
            <li><a href="./about.html">About</a></li>
            <li><a href="./contact.html">Contact</a></li>
        </ul>
    </div>

    <script>
        var vapiInstance = null;
        const assistant = "eea2ce9f-3124-462f-9a5c-3b6a0a16672b";
        const apiKey = "0cf8ba01-833e-42bc-8bb8-83cf4d3035b8";

        (function (d, t) {
            var g = document.createElement(t),
                s = d.getElementsByTagName(t)[0];
            g.src = "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
            g.defer = true;
            g.async = true;
            s.parentNode.insertBefore(g, s);

            g.onload = function () {
                // Initialize Vapi SDK without creating any widget
                if (window.vapiSDK && window.vapiSDK.Vapi) {
                    vapiInstance = new window.vapiSDK.Vapi({
                        apiKey: apiKey
                    });
                } else {
                    // Fallback to run method but with completely hidden config
                    vapiInstance = window.vapiSDK.run({
                        apiKey: apiKey,
                        assistant: assistant,
                        config: {
                            position: 'bottom-right',
                            offset: '-99999px',
                            width: '0px',
                            height: '0px',
                            idle: { color: 'rgba(0,0,0,0)', display: 'none' },
                            loading: { color: 'rgba(0,0,0,0)', display: 'none' },
                            active: { color: 'rgba(0,0,0,0)', display: 'none' }
                        }
                    });
                }
                
                // Add click handler to our custom button
                const customBtn = document.getElementById('vapi-voice-btn');
                const waveformCanvas = document.getElementById('waveform-canvas');
                const callStatus = document.getElementById('call-status');
                let isCallActive = false;
                let waveformAnimation = null;
                
                if (customBtn) {
                    customBtn.addEventListener('click', function() {
                        if (vapiInstance) {
                            if (isCallActive) {
                                if (vapiInstance.stop) {
                                    vapiInstance.stop();
                                }
                            } else {
                                if (vapiInstance.start) {
                                    vapiInstance.start(assistant);
                                } else if (vapiInstance.call) {
                                    vapiInstance.call({ assistant: assistant });
                                }
                            }
                        }
                    });
                }
                
                if (vapiInstance) {
                    vapiInstance.on('call-start', () => {
                        console.log('Call started');
                        isCallActive = true;
                        customBtn.setAttribute('data-state', 'active');
                        waveformCanvas.style.display = 'block';
                        callStatus.style.display = 'block';
                        startWaveformAnimation();
                    });
                    
                    vapiInstance.on('call-end', () => {
                        console.log('Call ended');
                        isCallActive = false;
                        customBtn.setAttribute('data-state', '');
                        waveformCanvas.style.display = 'none';
                        callStatus.style.display = 'none';
                        stopWaveformAnimation();
                    });
                    
                    vapiInstance.on('message', (message) => {
                        if (message.type === 'transcript') {
                            console.log(`${message.role}: ${message.transcript}`);
                        }
                    });
                }
                
                function startWaveformAnimation() {
                    const canvas = waveformCanvas;
                    const ctx = canvas.getContext('2d');
                    let time = 0;
                    const numLines = 25;
                    const lineWidth = 3;
                    const spacing = canvas.width / numLines;
                    let audioData = new Array(numLines).fill(0.1); // Initialize with idle state
                    let smoothedData = new Array(numLines).fill(0.1);
                    
                    // Try to get audio context for real-time analysis
                    let audioContext = null;
                    let analyser = null;
                    let dataArray = null;
                    
                    // Initialize audio analysis if possible
                    function initAudioAnalysis() {
                        try {
                            if (vapiInstance && vapiInstance.getAudioContext) {
                                audioContext = vapiInstance.getAudioContext();
                            } else if (window.AudioContext || window.webkitAudioContext) {
                                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            }
                            
                            if (audioContext) {
                                analyser = audioContext.createAnalyser();
                                analyser.fftSize = 64; // Small size for performance
                                dataArray = new Uint8Array(analyser.frequencyBinCount);
                                
                                // Try to connect to VAPI audio stream
                                if (vapiInstance && vapiInstance.getMediaStream) {
                                    const stream = vapiInstance.getMediaStream();
                                    if (stream) {
                                        const source = audioContext.createMediaStreamSource(stream);
                                        source.connect(analyser);
                                    }
                                }
                            }
                        } catch (error) {
                            console.log('Audio analysis not available, using simulated data');
                        }
                    }
                    
                    function updateAudioData() {
                        if (analyser && dataArray) {
                            analyser.getByteFrequencyData(dataArray);
                            
                            // Map frequency data to our bars
                            for (let i = 0; i < numLines; i++) {
                                const dataIndex = Math.floor((i / numLines) * dataArray.length);
                                const rawValue = dataArray[dataIndex] / 255;
                                audioData[i] = Math.max(rawValue, 0.05); // Minimum idle level
                            }
                        } else {
                            // Fallback: gentle wave motion with small idle movement
                            for (let i = 0; i < numLines; i++) {
                                const wavePhase = (i * 0.2) + (time * 0.01);
                                const baseHeight = Math.sin(wavePhase) * 0.15 + 0.15; // Smaller idle movement
                                const randomVariation = (Math.random() - 0.5) * 0.05; // Less randomness
                                audioData[i] = Math.max(baseHeight + randomVariation, 0.05);
                            }
                        }
                        
                        // Smooth the data for natural movement
                        for (let i = 0; i < numLines; i++) {
                            smoothedData[i] = smoothedData[i] * 0.7 + audioData[i] * 0.3;
                        }
                    }
                    
                    function animate() {
                        if (!isCallActive) return;
                        
                        updateAudioData();
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.strokeStyle = '#111';
                        ctx.lineWidth = lineWidth;
                        ctx.lineCap = 'round';
                        
                        const centerY = canvas.height / 2;
                        const maxHeight = canvas.height * 0.8;
                        
                        for (let i = 0; i < numLines; i++) {
                            const x = (i + 0.5) * spacing;
                            const height = smoothedData[i] * maxHeight;
                            
                            const startY = centerY - height / 2;
                            const endY = centerY + height / 2;
                            
                            ctx.beginPath();
                            ctx.moveTo(x, startY);
                            ctx.lineTo(x, endY);
                            ctx.stroke();
                        }
                        
                        time++;
                        waveformAnimation = requestAnimationFrame(animate);
                    }
                    
                    // Initialize audio analysis when starting
                    initAudioAnalysis();
                    animate();
                }
                
                function stopWaveformAnimation() {
                    if (waveformAnimation) {
                        cancelAnimationFrame(waveformAnimation);
                        waveformAnimation = null;
                    }
                    
                    const canvas = waveformCanvas;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            };
        })(document, "script");
    </script>
    <script src="./config.js"></script>
    <script src="./static/app.js"></script>
</body>
</html>
